--- copy-builtin	2013-11-06 23:19:16.000000000 +0000
+++ copy-builtin2	2015-12-09 15:58:11.508598747 +0000
@@ -56,6 +56,8 @@
 for MODULE in "${MODULES[@]}"
 do
 	adjust_obj_paths "$KERNEL_DIR/spl/$MODULE/Makefile"
+	sed -i.bak '/obj =/d' "$KERNEL_DIR/spl/$MODULE/Makefile"
+	sed -i.bak '/src =/d' "$KERNEL_DIR/spl/$MODULE/Makefile"
 done
 
 cat > "$KERNEL_DIR/spl/Kconfig" <<"EOF"
@@ -63,11 +65,8 @@
 	tristate "Solaris Porting Layer (SPL)"
 	help
 	  This is the SPL library from the ZFS On Linux project.
-
 	  See http://zfsonlinux.org/
-
 	  To compile this library as a module, choose M here.
-
 	  If unsure, say N.
 EOF
 
@@ -76,7 +75,6 @@
 	SPL_MODULE_CFLAGS  = -I$(srctree)/include/spl
 	SPL_MODULE_CFLAGS += -include $(srctree)/spl_config.h
 	export SPL_MODULE_CFLAGS
-
 	obj-$(CONFIG_SPL) :=
 	EOF
 
@@ -112,12 +110,12 @@
 }
 
 add_after "$KERNEL_DIR/Kconfig" 'source "arch/$SRCARCH/Kconfig"' 'source "spl/Kconfig"'
-# We must take care to build SPL before ZFS, else module initialization order will be wrong
-sed -i 's#kernel/ mm/ fs/#kernel/ mm/ spl/ fs/#' "$KERNEL_DIR/Makefile"
+# We must take care to build SPL before ZFS, otherwise the symbols required
+# to link ZFS will not be available.
+sed -i 's#+= kernel/#+= kernel/ spl/#' "$KERNEL_DIR/Makefile"
 
 echo >&2
 echo "    $0: done." >&2
 echo "    $0: now you can build the kernel with SPL support." >&2
 echo "    $0: make sure you enable SPL support (CONFIG_SPL) before building." >&2
 echo >&2
-
