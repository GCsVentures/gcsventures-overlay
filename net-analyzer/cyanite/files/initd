#!/sbin/openrc-run
# Copyright 1999-2016 Gentoo Foundation
# Distributed under the terms of the GNU General Public License v2
# $Id$

export JAVA_HOME=`java-config --jre-home`

checkconfig() {
  if [ ! -r "${CYANITE_CONFIG_FILE}" ]; then
    eerror "CYANITE_CONFIG_FILE doesn't point to a readable config file"
  fi
}

depend() {
  need net
}

start() {
  checkconfig || return 1

  [ -e `dirname "$CYANITE_PID_FILE"` ] || \
    install -d -o${CYANITE_USER} -g${CYANITE_GROUP} -m750 `dirname "$CYANITE_PID_FILE"`

  CLASSPATH="$(java-config -r)"
  if [ -r /usr/share/netty-transport-native-epoll/lib/netty-transport-native-epoll.jar ]; then
    CLASSPATH="${CLASSPATH}:$(java-config -d --classpath netty-transport-native-epoll)"
  fi

  einfo $CLASSPATH

  start-stop-daemon \
    --start \
    --exec "${JAVA_HOME}/bin/java" \
    --user ${CYANITE_USER} \
    --group ${CYANITE_GROUP} \
    --pidfile "${CYANITE_PID_FILE}" \
    --env CLASSPATH="${CLASSPATH}" \
    --make-pidfile \
    --background \
    -- -classpath "${CLASSPATH}" -jar /usr/share/cyanite/lib/cyanite.jar -f "${CYANITE_CONFIG_FILE}" ${CYANITE_OPTIONS}
}

stop() {
  start-stop-daemon \
    --stop \
    --pidfile "${CYANITE_PID_FILE}"
}
